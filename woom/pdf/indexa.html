<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Safari Fix</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 50px; }
        .btn { padding: 15px 25px; margin: 10px; cursor: pointer; border: none; border-radius: 8px; color: white; font-size: 18px; width: 250px; }
        .download-btn { background-color: #27ae60; }
        .open-btn { background-color: #2980b9; }
        #progressContainer { display: none; width: 300px; margin: 20px auto; background: #eee; border-radius: 10px; }
        #progressBar { width: 0%; height: 15px; background: #3498db; border-radius: 10px; transition: width 0.1s; }
    </style>
</head>
<body>

    <h2>Safari Optimized PDF System</h2>

    <div id="progressContainer">
        <div id="progressBar"></div>
        <p id="statusText" style="font-size:12px;">Download in corso...</p>
    </div>

    <button id="openBtn" class="btn open-btn">Apri il PDF</button><br>
    <button id="downloadBtn" class="btn download-btn">Scarica il PDF</button>

    <script>
        const PDF_URL = "Merceologia_20alimentare_20e_20igiene_20alimenti_20CORSO_20BAR.pdf";
        const DB_NAME = "SafariFixDB";
        const STORE_NAME = "pdf_cache";

        // IndexedDB initialization
        async function getDB() {
            return new Promise((resolve) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (e) => e.target.result.createObjectStore(STORE_NAME);
                request.onsuccess = (e) => resolve(e.target.result);
            });
        }

        // Save & Get from Local Storage
        async function saveToLocal(blob) {
            const db = await getDB();
            const tx = db.transaction(STORE_NAME, "readwrite");
            tx.objectStore(STORE_NAME).put(blob, "saved_file");
        }

        async function getFromLocal() {
            const db = await getDB();
            const tx = db.transaction(STORE_NAME, "readonly");
            return new Promise(res => {
                const req = tx.objectStore(STORE_NAME).get("saved_file");
                req.onsuccess = () => res(req.result);
            });
        }

        // Progress Bar Fetch
        async function downloadAndCache() {
            const response = await fetch(PDF_URL);
            const reader = response.body.getReader();
            const total = +response.headers.get('Content-Length');
            
            document.getElementById('progressContainer').style.display = 'block';
            let loaded = 0;
            let chunks = [];

            while(true) {
                const {done, value} = await reader.read();
                if (done) break;
                chunks.push(value);
                loaded += value.length;
                let pc = Math.round((loaded / total) * 100);
                document.getElementById('progressBar').style.width = pc + "%";
                document.getElementById('statusText').innerText = "Salvataggio locale: " + pc + "%";
            }

            document.getElementById('progressContainer').style.display = 'none';
            const blob = new Blob(chunks, { type: 'application/pdf' });
            await saveToLocal(blob);
            return blob;
        }

        async function handle(action) {
            let blob = await getFromLocal();
            
            // First time use
            if (!blob) {
                blob = await downloadAndCache();
            }

            const blobUrl = URL.createObjectURL(blob);

            if (action === 'open') {
                // Safari bypass: window.open ki jagah location change ya iframe
                // Isse popup blocker trigger nahi hota
                window.location.href = blobUrl;
            } else {
                // Safari Force Download Trick
                const link = document.createElement('a');
                link.href = blobUrl;
                link.setAttribute('download', 'Documento_Merceologia.pdf');
                
                // Safari needs the link to be in DOM
                document.body.appendChild(link);
                link.click();
                
                // Cleanup
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(blobUrl);
                }, 200);
            }
        }

        document.getElementById('openBtn').addEventListener('click', () => handle('open'));
        document.getElementById('downloadBtn').addEventListener('click', () => handle('download'));
    </script>
</body>
</html>
