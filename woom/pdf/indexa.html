<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF System - Safari Optimized</title>
    <style>
        :root {
            --primary: #2980b9;
            --success: #27ae60;
            --bg: #f4f7f6;
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
            width: 90%;
            max-width: 400px;
        }
        h2 { color: #333; margin-bottom: 25px; }
        .btn { 
            padding: 15px 20px; 
            margin: 10px 0; 
            cursor: pointer; 
            border: none; 
            border-radius: 8px; 
            color: white; 
            font-size: 16px; 
            font-weight: bold;
            width: 100%;
            transition: transform 0.2s, opacity 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .open-btn { background-color: var(--primary); }
        .download-btn { background-color: var(--success); }
        
        /* Progress Bar Styling */
        #progressContainer { 
            display: none; 
            width: 100%; 
            background: #eee; 
            border-radius: 10px; 
            margin: 20px 0;
            overflow: hidden;
        }
        #progressBar { 
            width: 0%; 
            height: 12px; 
            background: var(--primary); 
            transition: width 0.1s linear; 
        }
        #statusText { font-size: 13px; color: #666; margin-top: 8px; }
    </style>
</head>
<body>

    <div class="container">
        <h2>Area Documenti</h2>

        <button id="openBtn" class="btn open-btn">APRI IL PDF</button>
        <button id="downloadBtn" class="btn download-btn">SCARICA IL PDF</button>

        <div id="progressContainer">
            <div id="progressBar"></div>
            <p id="statusText">Inizializzazione...</p>
        </div>
    </div>

    <script>
        // CONFIGURAZIONE
        const PDF_URL = "Merceologia_20alimentare_20e_20igiene_20alimenti_20CORSO_20BAR.pdf";
        const DB_NAME = "PDF_Cache_System";
        const STORE_NAME = "files";
        const FILE_KEY = "main_pdf";
        const EXPIRY = 24 * 60 * 60 * 1000; // 24 ore

        // 1. DATABASE LOGIC (IndexedDB for Local Storage)
        function openDatabase() {
            return new Promise((resolve) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (e) => e.target.result.createObjectStore(STORE_NAME);
                request.onsuccess = (e) => resolve(e.target.result);
            });
        }

        async function saveToCache(blob) {
            const db = await openDatabase();
            const tx = db.transaction(STORE_NAME, "readwrite");
            tx.objectStore(STORE_NAME).put({ 
                blob: blob, 
                timestamp: Date.now() 
            }, FILE_KEY);
        }

        async function getFromCache() {
            const db = await openDatabase();
            return new Promise((resolve) => {
                const tx = db.transaction(STORE_NAME, "readonly");
                const req = tx.objectStore(STORE_NAME).get(FILE_KEY);
                req.onsuccess = () => {
                    const data = req.result;
                    if (data && (Date.now() - data.timestamp < EXPIRY)) {
                        resolve(data.blob);
                    } else {
                        resolve(null);
                    }
                };
            });
        }

        // 2. FETCH WITH PROGRESS
        async function startDownload() {
            const response = await fetch(PDF_URL);
            if (!response.ok) throw new Error("File non trovato");

            const reader = response.body.getReader();
            const total = +response.headers.get('Content-Length') || 0;
            
            document.getElementById('progressContainer').style.display = 'block';
            
            let loaded = 0;
            let chunks = [];

            while(true) {
                const {done, value} = await reader.read();
                if (done) break;
                chunks.push(value);
                loaded += value.length;
                
                if (total > 0) {
                    let pc = Math.round((loaded / total) * 100);
                    document.getElementById('progressBar').style.width = pc + "%";
                    document.getElementById('statusText').innerText = `Scaricamento in corso: ${pc}%`;
                }
            }

            const finalBlob = new Blob(chunks, { type: 'application/pdf' });
            await saveToCache(finalBlob);
            document.getElementById('progressContainer').style.display = 'none';
            return finalBlob;
        }

        // 3. ACTION HANDLER (Open/Download)
        async function handleAction(type) {
            let blob = await getFromCache();

            // Agar cache mein nahi hai toh download karo
            if (!blob) {
                try {
                    blob = await startDownload();
                } catch (err) {
                    alert("Errore durante il caricamento del file.");
                    return;
                }
            }

            if (type === 'open') {
                // Open: Safari viewer logic
                const blobUrl = URL.createObjectURL(blob);
                window.location.href = blobUrl; 
            } else {
                // Download: Safari Force Trick (Octet-Stream)
                // Hum file ka type change karte hain taaki Safari ise browser mein na khole
                const downloadBlob = new Blob([blob], { type: 'application/octet-stream' });
                const blobUrl = URL.createObjectURL(downloadBlob);
                
                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = "Documento_Merceologia.pdf";
                
                document.body.appendChild(link);
                link.click();
                
                // Cleanup
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(blobUrl);
                }, 250);
            }
        }

        // Event Listeners
        document.getElementById('openBtn').addEventListener('click', () => handleAction('open'));
        document.getElementById('downloadBtn').addEventListener('click', () => handleAction('download'));

    </script>
</body>
</html>
