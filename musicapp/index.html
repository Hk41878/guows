<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Offline Music Player</title>
  <style>
    body { font-family: sans-serif; background: #111; color: white; padding: 20px; }
    .status { margin-bottom: 20px; font-weight: bold; }
    .song { display: flex; align-items: center; justify-content: space-between; margin: 10px 0; }
    .icon { width: 24px; height: 24px; cursor: pointer; margin-left: 10px; }
    .section { margin-top: 20px; }
  </style>
</head>
<body>
  <div class="status" id="status">Checking connection...</div>
  <div id="songs-list"></div>
  <div class="section">
    <h3>Offline Songs:</h3>
    <div id="offline-songs"></div>
  </div>
  <div class="section">
    <h3>Smart Saved Songs:</h3>
    <div id="smart-songs"></div>
  </div>

  <script>
    const songs = [
      { title: 'Song 1', file: 'songs/song1.mp3' },
      { title: 'Song 2', file: 'songs/song2.mp3' },
      { title: 'Song 3', file: 'songs/song3.mp3' },
      { title: 'Song 4', file: 'songs/song4.mp3' },
      { title: 'Song 5', file: 'songs/song5.mp3' }
    ];

    const MAX_AUTO = 30;
    const offlineKeys = 'offlineSongs';
    const autoKeys = 'autoCachedSongs';

    const status = document.getElementById('status');
    const list = document.getElementById('songs-list');
    const offlineList = document.getElementById('offline-songs');
    const smartList = document.getElementById('smart-songs');

    const isOnline = () => navigator.onLine;

    function updateStatus() {
      status.textContent = isOnline() ? 'You are ONLINE' : 'You are OFFLINE';
    }

    async function cacheSong(url) {
      const cache = await caches.open('offline-music-v1');
      const response = await fetch(url);
      await cache.put(url, response);
    }

    async function removeSongFromCache(url) {
      const cache = await caches.open('offline-music-v1');
      await cache.delete(url);
    }

    function getStoredList(key) {
      return JSON.parse(localStorage.getItem(key) || '[]');
    }

    function setStoredList(key, list) {
      localStorage.setItem(key, JSON.stringify(list));
    }

    function addAutoSong(url) {
      let list = getStoredList(autoKeys);
      if (!list.includes(url)) {
        if (list.length >= MAX_AUTO) {
          // Remove oldest not in offline list
          const offline = getStoredList(offlineKeys);
          const toRemove = list.find(x => !offline.includes(x));
          if (toRemove) {
            removeSongFromCache(toRemove);
            list = list.filter(x => x !== toRemove);
          }
        }
        list.push(url);
        setStoredList(autoKeys, list);
      }
    }

    function render() {
      list.innerHTML = '';
      offlineList.innerHTML = '';
      smartList.innerHTML = '';

      const offline = getStoredList(offlineKeys);
      const auto = getStoredList(autoKeys);

      if (isOnline()) {
        songs.forEach(song => {
          const div = document.createElement('div');
          div.className = 'song';
          div.innerHTML = `
            <span>${song.title}</span>
            <span>
              <audio controls src="${song.file}"></audio>
              <img class="icon" src="${offline.includes(song.file) ? 'icons/remove.png' : 'icons/download.png'}"
                onclick="toggleOffline('${song.file}')">
            </span>
          `;
          list.appendChild(div);
        });
      } else {
        songs.forEach(song => {
          if (offline.includes(song.file)) {
            const div = document.createElement('div');
            div.className = 'song';
            div.innerHTML = `
              <span>${song.title}</span>
              <audio controls src="${song.file}"></audio>
              <img class="icon" src="icons/remove.png" onclick="toggleOffline('${song.file}')">
            `;
            offlineList.appendChild(div);
          } else if (auto.includes(song.file)) {
            const div = document.createElement('div');
            div.className = 'song';
            div.innerHTML = `
              <span>${song.title}</span>
              <audio controls src="${song.file}"></audio>
              <img class="icon" src="icons/remove.png" onclick="removeSmart('${song.file}')">
            `;
            smartList.appendChild(div);
          }
        });
      }
    }

    window.toggleOffline = async function(url) {
      let offline = getStoredList(offlineKeys);
      if (offline.includes(url)) {
        offline = offline.filter(x => x !== url);
        await removeSongFromCache(url);
      } else {
        offline.push(url);
        await cacheSong(url);
      }
      setStoredList(offlineKeys, offline);
      render();
    }

    window.removeSmart = async function(url) {
      let auto = getStoredList(autoKeys);
      auto = auto.filter(x => x !== url);
      await removeSongFromCache(url);
      setStoredList(autoKeys, auto);
      render();
    }

    window.addEventListener('load', () => {
      updateStatus();
      render();

      document.querySelectorAll('audio').forEach(audio => {
        audio.addEventListener('play', async e => {
          const url = e.target.src;
          if (isOnline()) {
            await cacheSong(url);
            addAutoSong(url);
          }
        });
      });
    });

    window.addEventListener('online', () => {
      updateStatus();
      render();
    });

    window.addEventListener('offline', () => {
      updateStatus();
      render();
    });
  </script>
</body>
</html>
